{% extends 'base.html' %}
{% block title %}{{ trade.pet_to_trade.owner_id.username }}'s {{ trade.pet_to_trade.pet_id.pet_species }} | Trading{% endblock %}
{% load static %}
{% load custom_filters %}

{% block trading_active %}
    active
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'trading.css' %}">
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-evenly align-items-center">
        <div class="d-flex flex-column align-items-center gap-3">
            <div class="trade-view-image-container rounded d-flex justify-content-center align-items-center">
                <img src="{{ trade.pet_to_trade.pet_id.pet_image.url }}" alt="" height="300px">
            </div>
            <h4 class="fw-bold m-0">{{ trade.pet_to_trade.owner_id.username }}</h4>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" height="100px" fill="white"><!--!Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M438.6 150.6c12.5-12.5 12.5-32.8 0-45.3l-96-96c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L338.7 96 32 96C14.3 96 0 110.3 0 128s14.3 32 32 32l306.7 0-41.4 41.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l96-96zm-333.3 352c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 416 416 416c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0 41.4-41.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-96 96c-12.5 12.5-12.5 32.8 0 45.3l96 96z"/></svg>

        <div class="d-flex flex-column align-items-center gap-3">
            <div class="trade-view-image-container rounded d-flex justify-content-center align-items-center">
                {% if trade.pet_to_offer %}
                    <img src="{{ trade.pet_to_offer.pet_id.pet_image.url }}" alt="" height="300px">
                {% else %}
                {% endif %}
            </div>
            {% if trade.pet_to_offer %}
                <h4 class="fw-bold m-0">{{ trade.pet_to_offer.owner_id.username }}</h4>
            {% elif trade.pet_to_trade.owner_id == request.user %}
                <button class="btn btn-primary" disabled>Trade Pet</button>
            {% else %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#offer-modal">Trade Pet</button>

                <div class="modal fade" id="offer-modal" tabindex="-1" aria-labelledby="offer-modal" aria-hidden="true">
                    <div class="modal-dialog">
                        <form class="modal-content" method="POST">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="offer-modal-title">Trade a Pet/Swap Pet</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="my-3 mx-5" >
                                    <select class="form-select" name="selected-offer" id="selected-offer">
                                        <option value="" selected disabled hidden>Select a Pet to trade...</option>
                                        {% for pet in pets %}
                                            <option value="{{ pet.id }}">{{ pet.pet_id.pet_species }}</option>
                                        {% endfor %}
                                    </select>
                                <div class="d-flex justify-content-center align-items-center my-3 rounded image-parent">
                                    <img height="180px" id="selected_pet_image" src="">
                                </div>
                                <div class="container px-4">
                                    <div class="row">
                                        <div class="col d-flex justify-content-between align-items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" height="20px" fill="white"><!--!Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M128 0c17.7 0 32 14.3 32 32l0 32 128 0 0-32c0-17.7 14.3-32 32-32s32 14.3 32 32l0 32 48 0c26.5 0 48 21.5 48 48l0 48L0 160l0-48C0 85.5 21.5 64 48 64l48 0 0-32c0-17.7 14.3-32 32-32zM0 192l448 0 0 272c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 192zm64 80l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16zm128 0l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0zM64 400l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16zm144-16c-8.8 0-16 7.2-16 16l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0zm112 16l0 32c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-32c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16z"/></svg>
                                            <span class="fw-bold pet_subtext" id="selected_pet_date"></span>
                                        </div>
                                        <div class="col-5 d-flex justify-content-between align-items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="20px" fill="white"><!--!Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M512 80c0 18-14.3 34.6-38.4 48c-29.1 16.1-72.5 27.5-122.3 30.9c-3.7-1.8-7.4-3.5-11.3-5C300.6 137.4 248.2 128 192 128c-8.3 0-16.4 .2-24.5 .6l-1.1-.6C142.3 114.6 128 98 128 80c0-44.2 86-80 192-80S512 35.8 512 80zM160.7 161.1c10.2-.7 20.7-1.1 31.3-1.1c62.2 0 117.4 12.3 152.5 31.4C369.3 204.9 384 221.7 384 240c0 4-.7 7.9-2.1 11.7c-4.6 13.2-17 25.3-35 35.5c0 0 0 0 0 0c-.1 .1-.3 .1-.4 .2c0 0 0 0 0 0s0 0 0 0c-.3 .2-.6 .3-.9 .5c-35 19.4-90.8 32-153.6 32c-59.6 0-112.9-11.3-148.2-29.1c-1.9-.9-3.7-1.9-5.5-2.9C14.3 274.6 0 258 0 240c0-34.8 53.4-64.5 128-75.4c10.5-1.5 21.4-2.7 32.7-3.5zM416 240c0-21.9-10.6-39.9-24.1-53.4c28.3-4.4 54.2-11.4 76.2-20.5c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 19.3-16.5 37.1-43.8 50.9c-14.6 7.4-32.4 13.7-52.4 18.5c.1-1.8 .2-3.5 .2-5.3zm-32 96c0 18-14.3 34.6-38.4 48c-1.8 1-3.6 1.9-5.5 2.9C304.9 404.7 251.6 416 192 416c-62.8 0-118.6-12.6-153.6-32C14.3 370.6 0 354 0 336l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 342.6 135.8 352 192 352s108.6-9.4 148.1-25.9c7.8-3.2 15.3-6.9 22.4-10.9c6.1-3.4 11.8-7.2 17.2-11.2c1.5-1.1 2.9-2.3 4.3-3.4l0 3.4 0 5.7 0 26.3zm32 0l0-32 0-25.9c19-4.2 36.5-9.5 52.1-16c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 10.5-5 21-14.9 30.9c-16.3 16.3-45 29.7-81.3 38.4c.1-1.7 .2-3.5 .2-5.3zM192 448c56.2 0 108.6-9.4 148.1-25.9c16.3-6.8 31.5-15.2 43.9-25.5l0 35.4c0 44.2-86 80-192 80S0 476.2 0 432l0-35.4c12.5 10.3 27.6 18.7 43.9 25.5C83.4 438.6 135.8 448 192 448z"/></svg>
                                            <span class="fw-bold pet_subtext" id="selected_pet_rate"></span>
                                        </div>
                                    </div>
                                </div>
                                <script>
                                    document.getElementById("selected-offer").addEventListener("change", function () {
                                        const id = this.value;
                                        fetch(`/trade/get_pet/${id}`)
                                            .then(response => {
                                                return response.json()
                                            })
                                            .then(data => {
                                                document.getElementById("selected_pet_image").src = data.image_url;
                                                rarity = ["rarity_common","rarity_uncommon","rarity_rare","rarity_mythical","rarity_legendary"]
                                                document.getElementById("selected_pet_image").className = "";
                                                document.getElementById("selected_pet_image").classList.add(rarity[data.rarity])

                                                const date = new Date(data.date_pulled)
                                                const options = {
                                                    year: "numeric",
                                                    month: "short", // Abbreviated month name
                                                    day: "numeric",
                                                    hour: "numeric",
                                                    minute: "numeric",
                                                    hour12: true, // 12-hour clock format
                                                };

                                                document.getElementById("selected_pet_date").innerHTML = Intl.DateTimeFormat("en-US", options).format(date);
                                                document.getElementById("selected_pet_rate").innerHTML = data.rate + "/hour";
                                            })
                                    })
                                </script>

                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Send Offer</button>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="d-flex flex-column align-items-center">
        <div class="d-flex pet-preferences-container p-3 m-3 justify-content-evenly rounded">
            {% if trade.pet_preferences %}
                {% for pet in trade.pet_preferences %}
                    {% if pet == "x" %}
                        <div class="border rounded m-1 pref-mw">
                        </div>
                    {% else %}
                        <div class="border rounded m-1">
                            <img src="/media/pets/{{ pet }}.png" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{{ pet|title }}">
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
        {% if trade.pet_to_trade.owner_id == request.user and trade.status == "waiting" %}
            <form class="d-flex gap-2 w-50" method="POST">
            {% csrf_token %}
                <button class="btn btn-success flex-grow-1" name="trade-offer-status" value="ACCEPTED">Accept Trade</button>
                <button class="btn btn-danger flex-grow-1" name="trade-offer-status" value="DECLINED">Decline Trade</button>
            </form>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script>
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    </script>
{% endblock %}